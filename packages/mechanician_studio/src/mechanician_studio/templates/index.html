<!DOCTYPE html>

<html>
<head>
    <title>Daring Mechanician</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> -->
    <link rel="stylesheet" href="./static/styles.css">
    
</head>

<body>    
    <!-- Sidebar -->
    <div id="sidebar">
        <h1>Mechanician AI Studio</h1>
        
        <div id="sidebar-button-container-id" class="sidebar-button-container">
            <button id="new-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M16.7929 2.79289C18.0118 1.57394 19.9882 1.57394 21.2071 2.79289C22.4261 4.01184 22.4261 5.98815 21.2071 7.20711L12.7071 15.7071C12.5196 15.8946 12.2652 16 12 16H9C8.44772 16 8 15.5523 8 15V12C8 11.7348 8.10536 11.4804 8.29289 11.2929L16.7929 2.79289ZM19.7929 4.20711C19.355 3.7692 18.645 3.7692 18.2071 4.2071L10 12.4142V14H11.5858L19.7929 5.79289C20.2308 5.35499 20.2308 4.64501 19.7929 4.20711ZM6 5C5.44772 5 5 5.44771 5 6V18C5 18.5523 5.44772 19 6 19H18C18.5523 19 19 18.5523 19 18V14C19 13.4477 19.4477 13 20 13C20.5523 13 21 13.4477 21 14V18C21 19.6569 19.6569 21 18 21H6C4.34315 21 3 19.6569 3 18V6C3 4.34314 4.34315 3 6 3H10C10.5523 3 11 3.44771 11 4C11 4.55228 10.5523 5 10 5H6Z" fill="currentColor"></path>
                </svg>
                &nbsp;New Conversation
            </button>

            <button id="conversations-button">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.62188 3.07918C3.87597 2.571 4.39537 2.25 4.96353 2.25H13.0365C13.6046 2.25 14.124 2.571 14.3781 3.07918L15.75 5.82295V13.5C15.75 14.7426 14.7426 15.75 13.5 15.75H4.5C3.25736 15.75 2.25 14.7426 2.25 13.5V5.82295L3.62188 3.07918ZM13.0365 3.75H4.96353L4.21353 5.25H13.7865L13.0365 3.75ZM14.25 6.75H3.75V13.5C3.75 13.9142 4.08579 14.25 4.5 14.25H13.5C13.9142 14.25 14.25 13.9142 14.25 13.5V6.75ZM6.75 9C6.75 8.58579 7.08579 8.25 7.5 8.25H10.5C10.9142 8.25 11.25 8.58579 11.25 9C11.25 9.41421 10.9142 9.75 10.5 9.75H7.5C7.08579 9.75 6.75 9.41421 6.75 9Z" fill="currentColor"></path>
                </svg>
                &nbsp;Conversations
            </button>

            <button id="prompt-tools-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                 <path d="M10.663 6.3872C10.8152 6.29068 11 6.40984 11 6.59007V8C11 8.55229 11.4477 9 12 9C12.5523 9 13 8.55229 13 8V6.59007C13 6.40984 13.1848 6.29068 13.337 6.3872C14.036 6.83047 14.5 7.61105 14.5 8.5C14.5 9.53284 13.8737 10.4194 12.9801 10.8006C12.9932 10.865 13 10.9317 13 11V13C13 13.5523 12.5523 14 12 14C11.4477 14 11 13.5523 11 13V11C11 10.9317 11.0068 10.865 11.0199 10.8006C10.1263 10.4194 9.5 9.53284 9.5 8.5C9.5 7.61105 9.96397 6.83047 10.663 6.3872Z" fill="currentColor"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M4 5V19C4 20.6569 5.34315 22 7 22H19C19.3346 22 19.6471 21.8326 19.8325 21.5541C20.0179 21.2755 20.0517 20.9227 19.9225 20.614C19.4458 19.4747 19.4458 18.5253 19.9225 17.386C19.9737 17.2637 20 17.1325 20 17V3C20 2.44772 19.5523 2 19 2H7C5.34315 2 4 3.34315 4 5ZM6 5C6 4.44772 6.44772 4 7 4H18V16H7C6.64936 16 6.31278 16.0602 6 16.1707V5ZM7 18H17.657C17.5343 18.6699 17.5343 19.3301 17.657 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18Z" fill="currentColor"></path>
                </svg>
                &nbsp;Prompt Tools
            </button>

            <button id="resources-button">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.62188 3.07918C3.87597 2.571 4.39537 2.25 4.96353 2.25H13.0365C13.6046 2.25 14.124 2.571 14.3781 3.07918L15.75 5.82295V13.5C15.75 14.7426 14.7426 15.75 13.5 15.75H4.5C3.25736 15.75 2.25 14.7426 2.25 13.5V5.82295L3.62188 3.07918ZM13.0365 3.75H4.96353L4.21353 5.25H13.7865L13.0365 3.75ZM14.25 6.75H3.75V13.5C3.75 13.9142 4.08579 14.25 4.5 14.25H13.5C13.9142 14.25 14.25 13.9142 14.25 13.5V6.75ZM6.75 9C6.75 8.58579 7.08579 8.25 7.5 8.25H10.5C10.9142 8.25 11.25 8.58579 11.25 9C11.25 9.41421 10.9142 9.75 10.5 9.75H7.5C7.08579 9.75 6.75 9.41421 6.75 9Z" fill="currentColor"></path>
                </svg>
                &nbsp;Resources
            </button>

            <button id="ai-tools-button" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path d="M10.663 6.3872C10.8152 6.29068 11 6.40984 11 6.59007V8C11 8.55229 11.4477 9 12 9C12.5523 9 13 8.55229 13 8V6.59007C13 6.40984 13.1848 6.29068 13.337 6.3872C14.036 6.83047 14.5 7.61105 14.5 8.5C14.5 9.53284 13.8737 10.4194 12.9801 10.8006C12.9932 10.865 13 10.9317 13 11V13C13 13.5523 12.5523 14 12 14C11.4477 14 11 13.5523 11 13V11C11 10.9317 11.0068 10.865 11.0199 10.8006C10.1263 10.4194 9.5 9.53284 9.5 8.5C9.5 7.61105 9.96397 6.83047 10.663 6.3872Z" fill="currentColor"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M4 5V19C4 20.6569 5.34315 22 7 22H19C19.3346 22 19.6471 21.8326 19.8325 21.5541C20.0179 21.2755 20.0517 20.9227 19.9225 20.614C19.4458 19.4747 19.4458 18.5253 19.9225 17.386C19.9737 17.2637 20 17.1325 20 17V3C20 2.44772 19.5523 2 19 2H7C5.34315 2 4 3.34315 4 5ZM6 5C6 4.44772 6.44772 4 7 4H18V16H7C6.64936 16 6.31278 16.0602 6 16.1707V5ZM7 18H17.657C17.5343 18.6699 17.5343 19.3301 17.657 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18Z" fill="currentColor"></path>
                   </svg>
                &nbsp;AI Tools
            </button>

            <button id="ai-settings-button" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path d="M11.6439 3C10.9352 3 10.2794 3.37508 9.92002 3.98596L9.49644 4.70605C8.96184 5.61487 7.98938 6.17632 6.93501 6.18489L6.09967 6.19168C5.39096 6.19744 4.73823 6.57783 4.38386 7.19161L4.02776 7.80841C3.67339 8.42219 3.67032 9.17767 4.01969 9.7943L4.43151 10.5212C4.95127 11.4386 4.95127 12.5615 4.43151 13.4788L4.01969 14.2057C3.67032 14.8224 3.67339 15.5778 4.02776 16.1916L4.38386 16.8084C4.73823 17.4222 5.39096 17.8026 6.09966 17.8083L6.93502 17.8151C7.98939 17.8237 8.96185 18.3851 9.49645 19.294L9.92002 20.014C10.2794 20.6249 10.9352 21 11.6439 21H12.3561C13.0648 21 13.7206 20.6249 14.08 20.014L14.5035 19.294C15.0381 18.3851 16.0106 17.8237 17.065 17.8151L17.9004 17.8083C18.6091 17.8026 19.2618 17.4222 19.6162 16.8084L19.9723 16.1916C20.3267 15.5778 20.3298 14.8224 19.9804 14.2057L19.5686 13.4788C19.0488 12.5615 19.0488 11.4386 19.5686 10.5212L19.9804 9.7943C20.3298 9.17767 20.3267 8.42219 19.9723 7.80841L19.6162 7.19161C19.2618 6.57783 18.6091 6.19744 17.9004 6.19168L17.065 6.18489C16.0106 6.17632 15.0382 5.61487 14.5036 4.70605L14.08 3.98596C13.7206 3.37508 13.0648 3 12.3561 3H11.6439Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="2"></circle>
                </svg>
                &nbsp;AI Settings
            </button>

            <button id="add-users-button" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path d="M11.6439 3C10.9352 3 10.2794 3.37508 9.92002 3.98596L9.49644 4.70605C8.96184 5.61487 7.98938 6.17632 6.93501 6.18489L6.09967 6.19168C5.39096 6.19744 4.73823 6.57783 4.38386 7.19161L4.02776 7.80841C3.67339 8.42219 3.67032 9.17767 4.01969 9.7943L4.43151 10.5212C4.95127 11.4386 4.95127 12.5615 4.43151 13.4788L4.01969 14.2057C3.67032 14.8224 3.67339 15.5778 4.02776 16.1916L4.38386 16.8084C4.73823 17.4222 5.39096 17.8026 6.09966 17.8083L6.93502 17.8151C7.98939 17.8237 8.96185 18.3851 9.49645 19.294L9.92002 20.014C10.2794 20.6249 10.9352 21 11.6439 21H12.3561C13.0648 21 13.7206 20.6249 14.08 20.014L14.5035 19.294C15.0381 18.3851 16.0106 17.8237 17.065 17.8151L17.9004 17.8083C18.6091 17.8026 19.2618 17.4222 19.6162 16.8084L19.9723 16.1916C20.3267 15.5778 20.3298 14.8224 19.9804 14.2057L19.5686 13.4788C19.0488 12.5615 19.0488 11.4386 19.5686 10.5212L19.9804 9.7943C20.3298 9.17767 20.3267 8.42219 19.9723 7.80841L19.6162 7.19161C19.2618 6.57783 18.6091 6.19744 17.9004 6.19168L17.065 6.18489C16.0106 6.17632 15.0382 5.61487 14.5036 4.70605L14.08 3.98596C13.7206 3.37508 13.0648 3 12.3561 3H11.6439Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="2"></circle>
                </svg>
                &nbsp;Add Users
            </button>

            <button id="user-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path d="M11.6439 3C10.9352 3 10.2794 3.37508 9.92002 3.98596L9.49644 4.70605C8.96184 5.61487 7.98938 6.17632 6.93501 6.18489L6.09967 6.19168C5.39096 6.19744 4.73823 6.57783 4.38386 7.19161L4.02776 7.80841C3.67339 8.42219 3.67032 9.17767 4.01969 9.7943L4.43151 10.5212C4.95127 11.4386 4.95127 12.5615 4.43151 13.4788L4.01969 14.2057C3.67032 14.8224 3.67339 15.5778 4.02776 16.1916L4.38386 16.8084C4.73823 17.4222 5.39096 17.8026 6.09966 17.8083L6.93502 17.8151C7.98939 17.8237 8.96185 18.3851 9.49645 19.294L9.92002 20.014C10.2794 20.6249 10.9352 21 11.6439 21H12.3561C13.0648 21 13.7206 20.6249 14.08 20.014L14.5035 19.294C15.0381 18.3851 16.0106 17.8237 17.065 17.8151L17.9004 17.8083C18.6091 17.8026 19.2618 17.4222 19.6162 16.8084L19.9723 16.1916C20.3267 15.5778 20.3298 14.8224 19.9804 14.2057L19.5686 13.4788C19.0488 12.5615 19.0488 11.4386 19.5686 10.5212L19.9804 9.7943C20.3298 9.17767 20.3267 8.42219 19.9723 7.80841L19.6162 7.19161C19.2618 6.57783 18.6091 6.19744 17.9004 6.19168L17.065 6.18489C16.0106 6.17632 15.0382 5.61487 14.5036 4.70605L14.08 3.98596C13.7206 3.37508 13.0648 3 12.3561 3H11.6439Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="2"></circle>
                </svg>
                &nbsp;{{ name }}</button>

            <button id="logout-button">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md">
                    <path d="M11 3H7C5.89543 3 5 3.89543 5 5V19C5 20.1046 5.89543 21 7 21H11" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path><path d="M20 12H11M20 12L16 16M20 12L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                &nbsp;logout</button>
        </div>
    </div>
    

    <div id="header">
        <div class="select-container">
            <select id="ai_name">
            </select>
        </div>
        <input type="hidden" id="conversation_id" value="{{ conversation_id }}">
        <input type="hidden" id="dev_ui_active" value="{{ dev_ui_active }}">
    </div>

    <div id="content">
        <div id="messages"></div>
        <div class="scroll-indicator" id="scroll_indicator">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="m-1 text-token-text-primary">
                <path d="M17 13L12 18L7 13M12 6L12 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </div>
    </div>

    <div id="footer">
        <div id="input-container">
            <input type="file" id="file_input" style="display: none;" />
            <button id="attachment">
                <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9 7C9 4.23858 11.2386 2 14 2C16.7614 2 19 4.23858 19 7V15C19 18.866 15.866 22 12 22C8.13401 22 5 18.866 5 15V9C5 8.44772 5.44772 8 6 8C6.55228 8 7 8.44772 7 9V15C7 17.7614 9.23858 20 12 20C14.7614 20 17 17.7614 17 15V7C17 5.34315 15.6569 4 14 4C12.3431 4 11 5.34315 11 7V15C11 15.5523 11.4477 16 12 16C12.5523 16 13 15.5523 13 15V9C13 8.44772 13.4477 8 14 8C14.5523 8 15 8.44772 15 9V15C15 16.6569 13.6569 18 12 18C10.3431 18 9 16.6569 9 15V7Z" fill="white"></path>
                </svg>
            </button>
            <textarea id="input" placeholder="How can I assist you today?">{{ prompt | default('') }}</textarea>
            <button id="send">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-white dark:text-black">
                    <path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </button>
        </div>
    </div>

    <script src="./static/functions.js"></script>

    <script>

        var user_has_scrolled = false;
        var current_ai_response = null;
        const username = '{{ username }}';
  
        // Adjust the width on window resize
        window.addEventListener('resize', adjust_input_container_width);

        document.addEventListener('DOMContentLoaded', function() {
            const ai_names = {{ ai_names | tojson }};
            const initial_ai_name = '{{ ai_name }}';
            generate_ai_name_select_options(ai_names, initial_ai_name); // Generate AI name select options

            clear_messages_display();
            load_conversation_history(username, get_ai_name(), get_conversation_id());
            adjust_textarea_height_and_change_button_color();
            check_scroll();

            document.getElementById('content').addEventListener('scroll', function() {
                var content_element = document.getElementById('content');
                var maxScroll = content_element.scrollHeight - content_element.clientHeight;
                // This is a small threshold to determine if the user has scrolled close to the bottom
                var nearBottom = Math.abs(content_element.scrollTop - maxScroll) < 5;
                if (content_element.scrollTop < maxScroll) {
                    user_has_scrolled = true;
                } 
                if (nearBottom) {
                    user_has_scrolled = false; // Consider user at the bottom if they're within a small threshold of the bottom
                }
                check_scroll(); 
            });

            user_role = "{{ user_role }}"

            if (user_role  === 'Admin') {
                // If the user is an Admin, display the button by changing its display style from 'none' to 'block' or 'inline'
                document.getElementById('add-users-button').style.display = 'flex';
            }

            document.getElementById('add-users-button').addEventListener('click', function() {
                window.location.href = "/create_user?ai_name=" + encodeURIComponent('{{ ai_name }}');
            });

            document.getElementById('input').addEventListener('input', adjust_textarea_height_and_change_button_color);
            document.getElementById('input').focus();

            document.getElementById('logout-button').addEventListener('click', function() {
                perform_logout();
            });

            document.getElementById('user-button').addEventListener('click', function() {
                window.location.href = "/user?ai_name=" + encodeURIComponent(get_ai_name()) + "&conversation_id=" + encodeURIComponent(get_conversation_id());
            });

            document.getElementById('prompt-tools-button').addEventListener('click', function() {
                window.location.href = "/prompt_tools?ai_name=" + encodeURIComponent(get_ai_name()) + "&conversation_id=" + encodeURIComponent(get_conversation_id());
            });

            
            let dev_ui_active = document.getElementById('dev_ui_active').value;
            if (dev_ui_active == "True") {
                // If the user is an Admin, display the button by changing its display style from 'none' to 'block' or 'inline'
                document.getElementById('ai-tools-button').style.display = 'flex';
            }

            document.getElementById('ai-tools-button').addEventListener('click', function() {
                window.location.href = "/ai_tools?ai_name=" + encodeURIComponent(get_ai_name()) + "&conversation_id=" + encodeURIComponent(get_conversation_id());
            });

            
            if (dev_ui_active == "True") {
                // If the user is an Admin, display the button by changing its display style from 'none' to 'block' or 'inline'
                document.getElementById('ai-settings-button').style.display = 'flex';
            }

            document.getElementById('ai-settings-button').addEventListener('click', function() {
                window.location.href = "/ai_settings?ai_name=" + encodeURIComponent(get_ai_name()) + "&conversation_id=" + encodeURIComponent(get_conversation_id());
            });

            document.getElementById('conversations-button').addEventListener('click', function() {
                window.location.href = "/conversations?ai_name=" + encodeURIComponent(get_ai_name()) + "&conversation_id=" + encodeURIComponent(get_conversation_id());
            });

            document.getElementById('resources-button').addEventListener('click', function() {
                window.location.href = "/resources/" + username +"?ai_name=" + encodeURIComponent(get_ai_name());
            });

            document.getElementById('new-button').addEventListener('click', function() {

                $.ajax({
                    type: "POST",
                    url: "/new",
                    success: function(data) {
                        // Redirect or update UI on successful logout
                        window.location.href = "/?ai_name=" + encodeURIComponent(get_ai_name()) + "&new_conversation=true";
                    },
                    error: function(response) {
                        // Handle error
                        console.log("New sesssion failed:", response);
                    }
                });
            });

            // Initial adjustment on load
            adjust_input_container_width();
            var socket = check_session_init_ws(username, get_ai_name());
            // Check if there is any text in the textarea when the WebSocket connection is established and send the prompt
            function send_initial_input() {
                var textarea_value = document.getElementById('input').value;
                if (socket.readyState === WebSocket.OPEN) {
                    if (textarea_value !== '') {
                        send_prompt(socket, username, get_ai_name(), get_conversation_id());
                    }
                }
            }

            const ai_name_select = document.getElementById('ai_name');
            ai_name_select.addEventListener('change', function() {
                clear_messages_display();
                list_conversations(username, get_ai_name())
                    .then(function(data) {
                        if (data.length > 0) {
                            set_conversation_id(data[0].conversation_id);
                            load_conversation_history(username, get_ai_name(), get_conversation_id());
                        }
                    })
                    .catch(function(error) {
                        console.log(error);
                    });
                adjust_textarea_height_and_change_button_color();
                check_scroll();
            });
            
            setTimeout(send_initial_input, 500);
             
            check_scroll();
        });


    </script>
    
</body>
</html>
