<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User - Daring Mechanician</title>
    <link rel="stylesheet" href="./static/styles.css">
    <link rel="stylesheet" href="./static/form_styles.css">
    <style></style>
</head>
<body>
     <!-- Sidebar remains unchanged from your login.html -->
     <div id="sidebar">
        <h1>Daring Mechanician</h1>
        <!-- Additional sidebar content here -->
        <div id="logout-container" class="logout-container">
            <button id="new-button">&#x21BA; {{ ai_name }}</button>
            <button id="user-button">&#9965; {{ username }}</button>
            <button id="logout_button">&#x23FB; exit</button>
        </div>
    </div>

    <div class="form-container">
        <input type="text" id="username" placeholder="{{username}}" value="{{username}}">
        <input type="password" id="password" placeholder="Password">
        <input type="password" id="new_password" placeholder="New Password">
        <input type="password" id="confirm_new_password" placeholder="Confirm New Password">
        <button id="update_user_button">Update</button>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#username').focus();

            function performLogout() {
                console.log('Logging out...');
                console.log('Removing Token:', localStorage.getItem('jwt_token'));
                localStorage.removeItem('jwt_token');
                console.log('Token Removed:', localStorage.getItem('jwt_token'));
                console.log('Performing logout...');
                // Make a request to the logout endpoint
                $.ajax({
                    type: "POST",
                    url: "/logout",
                    success: function(data) {
                        // Redirect or update UI on successful logout
                        window.location.href = "/login";
                    },
                    error: function(response) {
                        // Handle error
                        console.log("Logout failed:", response);
                    }
                });
            }

            function update_user() {
                var username = $('#username').val();
                var password = $('#password').val();
                var new_password = $('#new_password').val();
                var confirm_new_password = $('#confirm_new_password').val();

                if(new_password !== confirm_new_password) {
                    alert("Passwords do not match.");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/user",
                    data: JSON.stringify({ // Convert the data to a JSON string
                        username: username, 
                        password: password,
                        new_password: new_password,
                        confirm_new_password: confirm_new_password
                    }),
                    contentType: "application/json; charset=utf-8", // Set the content type to JSON
                    dataType: "json", // Expect JSON in response from the server
                    success: function(data) {
                        alert("User successfully updated.");
                        window.location.href = "/user"; // Redirect to the login page after account creation
                    },
                    error: function(response) {
                        var errorMessage = "User update failed: ";
                        if (response.responseJSON && response.responseJSON.detail) {
                            errorMessage += response.responseJSON.detail;
                        } else {
                            errorMessage += "An unexpected error occurred.";
                        }
                        alert(errorMessage);
                    }
                });
            }


            $('#update_user_button').click(update_user);

            // Trigger login when Enter key is pressed in the password input
            $('#confirm_new_password').on('keypress', function(e) {
                if (e.which === 13) { // 13 is the Enter key
                    update_user();
                }
            });

            document.getElementById('user-button').addEventListener('click', function() {
                window.location.href = "/user";
            });

            document.getElementById('new-button').addEventListener('click', function() {
                window.location.href = "/";
            });

            document.getElementById('logout_button').addEventListener('click', function() {
                performLogout();
            });

        });
    </script>
</body>
</html>
